<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Vortex Curaduría (Local)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .row { margin-bottom: 10px; }
    pre { background: #f4f4f4; padding: 10px; overflow:auto; }
  </style>
</head>
<body>
  <h2>Subir documento (MVP)</h2>

<form id="f">
  <div class="row"><input name="title" placeholder="Título" required style="width:420px"/></div>

  <div class="row">
    <label>Dominio:</label>
    <select id="domainSelect" name="domain_id" required></select>
  </div>

  <div class="row">
    <label>Subdominio:</label>
    <select id="subdomainSelect" name="subdomain_id" required></select>
  </div>

  <div class="row">
    <label>Tipo:</label>
    <select name="document_type" required>
      <option value="guia_clinica">guia_clinica</option>
      <option value="protocolo">protocolo</option>
      <option value="manual">manual</option>
      <option value="norma">norma</option>
      <option value="ley">ley</option>
      <option value="estandar">estandar</option>
      <option value="politica_interna">politica_interna</option>
      <option value="otro">otro</option>
    </select>
  </div>

  <div class="row"><input name="authority_source" placeholder="Fuente (MINSAL/BCN/ISP/OMS/OPS/CDC)" required/></div>
  <div class="row"><input name="version" placeholder="Versión (v1)" value="v1"/></div>
  <div class="row"><input name="created_by_user_id" placeholder="user_id" value="local-user"/></div>
  <div class="row"><input name="organization_id" placeholder="org_id" value="local-org"/></div>
  <div class="row"><input type="file" name="pdf" accept="application/pdf" required/></div>

  <button type="submit">Evaluar y guardar</button>
</form>


  <h3>Resultado</h3>
  <pre id="out">(sin ejecutar)</pre>

<script>
  const API = "http://localhost:8000";

  const domainSelect = document.getElementById("domainSelect");
  const subdomainSelect = document.getElementById("subdomainSelect");

  async function loadDomains() {
    const res = await fetch(`${API}/domains`);
    const domains = await res.json();

    domainSelect.innerHTML = "";
    for (const d of domains) {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = `${d.name} (${d.code})`;
      domainSelect.appendChild(opt);
    }

    if (domains.length > 0) {
      await loadSubdomains(domains[0].id);
    }
  }

  async function loadSubdomains(domainId) {
    const res = await fetch(`${API}/subdomains?domain_id=${encodeURIComponent(domainId)}`);
    const subs = await res.json();

    subdomainSelect.innerHTML = "";
    for (const s of subs) {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${s.name} (${s.code})`;
      subdomainSelect.appendChild(opt);
    }
  }

  domainSelect.addEventListener("change", async (e) => {
    await loadSubdomains(e.target.value);
  });

  document.getElementById("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);

    const res = await fetch(`${API}/documents/upload`, { method: "POST", body: fd });
    const json = await res.json();
    document.getElementById("out").textContent = JSON.stringify(json, null, 2);
  });

  loadDomains();
</script>

</body>
</html>
